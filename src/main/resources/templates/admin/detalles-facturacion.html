<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
  <title>Buenos Ayres - Detalles de Facturación</title>

  <link rel="shortcut icon" href="../assets/img/favicon.png">

  <link
          href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,500;0,700;0,900;1,400;1,500;1,700&display=swap"
          rel="stylesheet">

  <link rel="stylesheet" href="../assets/plugins/bootstrap/css/bootstrap.min.css">

  <link rel="stylesheet" href="../assets/plugins/feather/feather.css">

  <link rel="stylesheet" href="../assets/plugins/icons/flags/flags.css">

  <link rel="stylesheet" href="../assets/plugins/fontawesome/css/fontawesome.min.css">
  <link rel="stylesheet" href="../assets/plugins/fontawesome/css/all.min.css">

  <link rel="stylesheet" href="../assets/plugins/datatables/datatables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11">

  <link rel="stylesheet" href="../assets/css/style.css">
  <style>
    .dataTables_filter {
      display: none;
    }

    /* Ocultar el checkbox "Marcar todos" */
    #checkbox-todos {
      display: none;
    }

    /* Estilo para la cabecera de la columna "Abonado" */
    #tabla-detalles-facturacion th:last-child {
      cursor: pointer;
      position: relative; /* Para posicionar el checkbox oculto */
    }

    /* Posicionar el checkbox oculto sobre la cabecera */
    #checkbox-todos {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      opacity: 0; /* Hacerlo completamente transparente */
      cursor: pointer;
    }
    #contenedor-boton-confirmar {
      position: absolute;
      bottom: 10px; /* Ajusta la distancia desde abajo */
      right: 10px; /* Ajusta la distancia desde la derecha */

    }
  </style>
</head>

<body>

<div class="main-wrapper">

  <div class="header">
    <div class="header-left">
      <a href="index" class="logo">
        <img src="../assets/img/logo.png" alt="Logo">
      </a>
      <a href="index" class="logo logo-small">
        <img src="../assets/img/logo-small.png" alt="Logo" width="30" height="30">
      </a>
    </div>
    <div class="menu-toggle">
      <a href="javascript:void(0);" id="toggle_btn">
        <i class="fas fa-bars"></i>
      </a>
    </div>

    <a class="mobile_btn" id="mobile_btn">
      <i class="fas fa-bars"></i>
    </a>
    <ul class="nav user-menu">
      <li class="nav-item zoom-screen me-2">
        <a href="#" class="nav-link header-nav-list">
          <img src="../assets/img/icons/header-icon-04.svg" alt="">
        </a>
      </li>
      <li class="nav-item dropdown has-arrow new-user-menus">
        <a href="#" class="dropdown-toggle nav-link" data-bs-toggle="dropdown">
                        <span class="user-img">
                            <img class="rounded-circle" src="../assets/img/profiles/avatar-01.jpg" width="31"
                                 alt="Soeng Souy">
                            <div class="user-text">
                                <h6>Buenos Ayres</h6>
                                <p class="text-muted mb-0">Administrador</p>
                            </div>
                        </span>
        </a>
        <div class="dropdown-menu">
          <div class="user-header">
            <div class="avatar avatar-sm">
              <img src="../assets/img/profiles/avatar-01.jpg" alt="User Image"
                   class="avatar-img rounded-circle">
            </div>
            <div class="user-text">
              <h6>Buenos Ayres</h6>
              <p class="text-muted mb-0">Administrador</p>
            </div>
          </div>

        </div>
      </li>
    </ul>
  </div>
  
<div class="sidebar" id="sidebar">
  <div class="sidebar-inner slimscroll">
    <div id="sidebar-menu" class="sidebar-menu">
      <ul>
        <li class="menu-title">
          <span>Menú Principal</span>
        </li>

        <li class="submenu">
          <a href="#"><i class="fas fa-graduation-cap"></i> <span> Alumnos</span> <span
                  class="menu-arrow"></span></a>
          <ul>
            <li><a href="alumnos">Lista de alumnos</a></li>
            <li><a href="agregar-alumno">Agregar alumno</a></li>
            <li><a href="editar-alumno">Editar alumno</a></li>
          </ul>
        </li>
        <li class="submenu">
          <a href="#"><i class="fas fa-home"></i> <span> Padres</span> <span
                  class="menu-arrow"></span></a>
          <ul>
            <li><a href="padres">Lista de Padres</a></li>
            <li><a href="agregar-padre">Agregar padre</a></li>
            <li><a href="editar-padre">Editar padre</a></li>
          </ul>
        </li>
        <li class="submenu">
          <a href="#"><i class="fas fa-users"></i> <span> Familias</span> <span
                  class="menu-arrow"></span></a>
          <ul>
            <li><a href="familias">Lista de familias</a></li>
            <li><a href="ver-familias">Detalles de familia</a></li>
            <li><a href="agregar-familia">Agregar familia</a></li>
            <li><a href="editar-familia">Editar familia</a></li>
          </ul>
        </li>

        <li class="submenu">
          <a href="#"><i class="fas fa-wrench"></i> <span> Talleres</span> <span
                  class="menu-arrow"></span></a>
          <ul>
            <li><a href="talleres">Lista de talleres</a></li>

          </ul>
        </li>
        <li class="submenu">
          <a href="#"><i class="fas fa-file-invoice-dollar"></i> <span> Conceptos</span> <span
                  class="menu-arrow"></span></a>
          <ul>
            <li><a href="conceptos">Revisar conceptos</a></li>

          </ul>
        </li>
        <li class="submenu">
          <a href="#"><i class="fas fa-comment-dollar"></i> <span>Facturación</span> <span
                  class="menu-arrow"></span></a>
          <ul>
            <li><a href="facturacion">Facturar</a></li>
            <li><a href="deudas">Deudas</a></li>

          </ul>
        </li>
        <li class="submenu">
          <a href="#"><i class="fas fa-chalkboard-teacher"></i> <span> Profesores</span> <span
                  class="menu-arrow"></span></a>
          <ul>
            <li><a href="profesores">Lista de profesores</a></li>
            <li><a href="agregar-profesor">Agregar profesor</a></li>
            <li><a href="editar-profesor">Editar profesor</a></li>
          </ul>
        </li>
        <li class="submenu">
          <a href="#"><i class="fas fa-chalkboard-teacher"></i> <span> Cursos</span> <span
                  class="menu-arrow"></span></a>
          <ul>
            <li><a href="cursos">Lista de Cursos</a></li>

          </ul>
        </li>
        <li class="submenu">
          <a href="#"><i class="fas fa-book"></i> <span> Materias</span> <span
                  class="menu-arrow"></span></a>
          <ul>
            <li><a href="materias">Lista de Materias</a></li>
            <li><a href="agregar-materia">Agregar Materia</a></li>
            <li><a href="editar-materia">Editar Materia</a></li>
          </ul>
        </li>
        <li class="submenu">
          <a href="#"><i class="fas fa-clipboard-list"></i> <span> Evaluaciones</span> <span
                  class="menu-arrow"></span></a>
          <ul>
            <li><a href="evaluaciones">Lista de Evaluaciones</a></li>
            <li><a href="agregar-evaluacion">Agregar Evaluación</a></li>
            <li><a href="evaluaciones-creadas">Evaluaciones Creadas</a></li>
          </ul>
        </li>
        <li class="submenu">
          <a href="#"><i class="fas fa-gavel"></i> <span> Disciplina</span> <span
                  class="menu-arrow"></span></a>
          <ul>
            <li><a href="disciplina">Lista de Sanciones</a></li>
            <li><a href="agregar-sancion">Agregar Sanción</a></li>
          </ul>
        </li>
        <li class="submenu">
          <a href="#"><i class="fas fa-user-clock"></i> <span> Inasistencias</span> <span
                  class="menu-arrow"></span></a>
          <ul>
            <li><a href="inasistencias">Lista de Inasistencias</a></li>
            <li><a href="agregar-inasistencia">Agregar Inasistencia</a></li>
          </ul>
        </li>
        <li class="submenu">
          <a href="#"><i class="fas fa-chart-bar"></i> <span> Reportes</span> <span class="menu-arrow"></span></a>
          <ul>
            <li><a href="ver-reportes">Ver Reportes</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</div>



  <div class="page-wrapper">
    <div class="content container-fluid">
      <div class="page-header">
        <div class="row">
          <div class="col-sm-12">
            <h3 class="page-title" id="titulo-familia">Detalles de Facturación </h3>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <div class="card card-table comman-shadow">
            <div class="card-body">

              <div class="page-header">
                <div class="row align-items-center">
                  <div class="col">
                    <h3 class="page-title" id="titulo"></h3>
                  </div>

                </div>
              </div>
      <div class="row">
        <div class="col-sm-12">
          <div class="card card-table comman-shadow">
            <div class="card-body">
              <div class="table-responsive">
                <table id="tabla-detalles-facturacion" class="table border-0 star-student table-hover table-center mb-0 table-striped">
                  <thead class="student-thread">
                  <tr>
                    <th hidden="hidden">ID</th>
                    <th>Concepto</th>
                    <th>Alumno</th>
                    <th>Monto</th>
                    <th>Descuento</th>
                    <th>Monto Final</th>
                    <th>Abonado
                      <input type="checkbox" id="checkbox-todos">
                    </th>
                  </tr>
                  </thead>
                  <tbody>
                  </tbody>
                  <tfoot>
                  <tr>
                    <th colspan="5" class="text-end"></th>
                    <th id="subtotal-footer" style="text-align: right;"></th>
                    <th></th>
                  </tr>
                  <tr id="contenedor-boton-confirmar" style="display: none;">
                    <td colspan="7" class="text-end">
                      <button id="boton-confirmar" class="btn btn-primary">Confirmar</button>
                    </td>
                  </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
  </div>
</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<script src="../assets/js/jquery-3.6.0.min.js"></script>
<script src="../assets/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="../assets/js/feather.min.js"></script>
<script src="../assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="../assets/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="../assets/plugins/datatables/datatables.min.js"></script>
<script src="../assets/js/script.js"></script>
            <script src="../assets/plugins/sweetalert/sweetalert2.all.min.js"></script>
<script th:inline="none">
  function formatearMoneda(numero) {
    return '$ ' + numero.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  var tabla;
  $(document).ready(function() {
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    if (id) {
      obtenerDetallesFacturacion(id);
    } else {
      console.error("No se proporcionó un ID de facturación válido.");
    }
  });

  function obtenerDetallesFacturacion(id) {
    $.ajax({
      url: `/api/v1/facturacion/detalles?id=${id}`, // Asegúrate de que esta URL sea correcta
      type: 'GET',
      dataType: 'json',
      success: function(data) {
        console.log(data)
        mostrarDetallesFacturacion(data);
      },
      error: function(error) {
        console.error('Error al obtener los detalles de la facturación:', error);
      }
    });
  }

  function mostrarDetallesFacturacion(data) {
    var periodo = new Date(data.periodo);
    var options = { year: 'numeric', month: 'long' };
    var periodo = periodo.toISOString().split('T')[0];
    periodo = periodo.charAt(0).toUpperCase() + periodo.slice(1);
    $('#titulo').text(`Familia ${data.apellido_familia} - ${periodo}`);
    //$('#total').text(`TOTAL: $${data.montoFinal}`)
    const tbody = $('#tabla-detalles-facturacion tbody');
    tbody.empty();


    let cambiosRealizados = false;
    data.detalles.forEach(detalle => {
      let concepto = '';
      if (detalle.concepto.descripcion) {
        concepto = detalle.concepto.descripcion;
      } else {
        concepto = `${detalle.concepto.tipoDeConcepto}`;
        if (detalle.concepto.nivel)
            concepto += ` ${detalle.concepto.nivel}`
      }
      const alumno = `${detalle.alumno.nombre} ${detalle.alumno.apellido}`;
      const descuento = `${detalle.descuento}%`;
      const montoFinal = detalle.concepto.monto - ((detalle.descuento / 100) * detalle.concepto.monto);

      // Formatear la fecha de pago
      let fechaPagoFormateada = '';
      if (detalle.fechaPago) {
        const fechaPago = new Date(detalle.fechaPago);
        const dia = fechaPago.getDate().toString().padStart(2, '0');
        const mes = (fechaPago.getMonth() + 1).toString().padStart(2, '0'); // Sumamos 1 al mes porque empieza en 0 (enero)
        const anio = fechaPago.getFullYear().toString().slice(-2); // Obtenemos los dos últimos dígitos del año
        fechaPagoFormateada = `${dia}/${mes}/${anio}`;
      }

      // Mostrar la fecha de pago o el checkbox
      const abonado = detalle.fechaPago
              ? fechaPagoFormateada // Mostrar la fecha si existe
              : `<input type="checkbox" class="checkbox-abonado" data-id="${detalle.id}">`; // Mostrar checkbox si no


      const newRow = `
                    <tr>
                        <td class="id-fila" style="display:none;">${detalle.id}</td>
                        <td>${concepto}</td>
                        <td>${alumno}</td>
                        <td>${formatearMoneda(detalle.concepto.monto)}</td>
                        <td>${descuento}</td>
                        <td>${formatearMoneda(montoFinal)}</td>
                        <td>${abonado}</td>
                    </tr>
                `;
      tbody.append(newRow);
    });
    let total = data.montoFinal;
    let totalAdeudado = 0;
    data.detalles.forEach(detalle => {
      if (!detalle.fechaPago) { // Sumar solo si no está abonado
        const montoFinal = detalle.concepto.monto - ((detalle.descuento / 100) * detalle.concepto.monto);
        totalAdeudado += montoFinal;
      }
    });
    // Inicializar DataTables
    tabla = $('#tabla-detalles-facturacion').DataTable({
      "order": [[0, 'asc']],
      "searching": false,
      "paging": false,
      "columnDefs": [
        { "orderable": false, "targets": 6 } // Deshabilitar ordenamiento en la columna "Abonado"
      ],
      "footerCallback": function(row, data, start, end, display) {
        console.log(total)

        $('#subtotal-footer').html(`
                        <p class="mb-0">TOTAL: ${formatearMoneda(total)}</p>
                        <p class="mb-0">TOTAL ADEUDADO: ${formatearMoneda(totalAdeudado)}</p>
                    `);
      }
    });

    // Manejar clics en los checkboxes de "Abonado"
    tbody.on('change', '.checkbox-abonado', function() {
      mostrarBotonConfirmar();
      cambiosRealizados = true;
    });

    // Manejar clic en el botón "Confirmar"
    $('#boton-confirmar').click(function() {
      const idsConceptos = [];
      $('.checkbox-abonado:checked').each(function() {
        idsConceptos.push($(this).data('id'));
      });
      console.log(idsConceptos)
      if (idsConceptos.length === 0) {
        alert("Por favor, seleccione al menos un concepto.");
        return;
      }
      // Mostrar SweetAlert para confirmación
      Swal.fire({
        title: '¿Confirmar abonado?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Confirmar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          // El usuario confirmó, enviar los datos al servidor
          $.ajax({
            url: '/api/v1/facturacion/deudas',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(idsConceptos),
            success: function (response) {
              console.log("Conceptos actualizados con éxito:", response);
              // Actualizar la interfaz de usuario o mostrar un mensaje de éxito
              Swal.fire(
                      'Confirmado!',
                      'Los conceptos han sido marcados como abonados.',
                      'success'
              )
              actualizarTabla(); // Recargar la tabla después de actualizar los conceptos
            },
            error: function (error) {
              console.error("Error al actualizar los conceptos:", error);
              // Mostrar un mensaje de error al usuario
              Swal.fire(
                      'Error!',
                      'Hubo un error al marcar los conceptos como abonados.',
                      'error'
              )
            }
          });
        }
      })
    });

    // Manejar el clic en la cabecera de la columna "Abonado"
    $('#tabla-detalles-facturacion th:last-child').click(function() {
      // Cambiar el estado del checkbox oculto
      $('#checkbox-todos').prop('checked', !$('#checkbox-todos').prop('checked'));

      // Actualizar los checkboxes de las filas
      $('.checkbox-abonado').prop('checked', $('#checkbox-todos').prop('checked'));

      // Mostrar/ocultar el botón "Confirmar"
      mostrarBotonConfirmar();
    });

    function actualizarTabla() {
      setTimeout(() => { location.reload(); }, 1500);
    }
    // Función para mostrar u ocultar el botón "Confirmar"
    function mostrarBotonConfirmar() {
      if ($('.checkbox-abonado:checked').length > 0) {
        $('#contenedor-boton-confirmar').show();
      } else {
        $('#contenedor-boton-confirmar').hide();
      }
    }
  }

</script>
</body>
</html>